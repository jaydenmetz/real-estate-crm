<!DOCTYPE html>
<html>
<head>
    <title>CRM Debug Console</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            color: #569cd6;
            margin-bottom: 20px;
            font-size: 28px;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .section {
            background: #2d2d30;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #3e3e42;
        }
        .section h2 {
            color: #4ec9b0;
            margin-bottom: 15px;
            font-size: 18px;
        }
        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #3e3e42;
        }
        .status-item:last-child {
            border-bottom: none;
        }
        .status-label {
            color: #9cdcfe;
        }
        .status-value {
            color: #ce9178;
            font-family: 'Courier New', monospace;
        }
        .status-value.success {
            color: #4ec9b0;
        }
        .status-value.error {
            color: #f48771;
        }
        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            font-size: 14px;
        }
        button:hover {
            background: #005a9e;
        }
        button.danger {
            background: #f48771;
        }
        button.danger:hover {
            background: #d16969;
        }
        button.success {
            background: #4ec9b0;
        }
        button.success:hover {
            background: #3ba395;
        }
        .log-container {
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .log-entry {
            margin-bottom: 8px;
            padding: 8px;
            background: #2d2d30;
            border-radius: 4px;
        }
        .log-entry.error {
            background: #5a1e1e;
            color: #f48771;
        }
        .log-entry.success {
            background: #1e3a1e;
            color: #4ec9b0;
        }
        .log-entry.info {
            background: #1e2e3a;
            color: #9cdcfe;
        }
        input[type="text"], input[type="password"], select {
            width: 100%;
            padding: 8px;
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            color: #d4d4d4;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .tab-container {
            margin-bottom: 20px;
        }
        .tabs {
            display: flex;
            border-bottom: 2px solid #3e3e42;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background: none;
            border: none;
            color: #d4d4d4;
            font-size: 14px;
        }
        .tab.active {
            color: #569cd6;
            border-bottom: 2px solid #569cd6;
            margin-bottom: -2px;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        pre {
            background: #1e1e1e;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .copy-btn {
            float: right;
            padding: 5px 10px;
            font-size: 12px;
            margin-top: -5px;
        }
        .response-viewer {
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            padding: 15px;
            margin-top: 10px;
            max-height: 500px;
            overflow: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ”§ CRM Debug Console</h1>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('status')">System Status</button>
            <button class="tab" onclick="switchTab('auth')">Authentication</button>
            <button class="tab" onclick="switchTab('api')">API Testing</button>
            <button class="tab" onclick="switchTab('logs')">Console Logs</button>
            <button class="tab" onclick="switchTab('data')">Debug Data</button>
        </div>

        <!-- Status Tab -->
        <div id="status-tab" class="tab-content active">
            <div class="grid">
                <div class="section">
                    <h2>Environment</h2>
                    <div id="environment-status"></div>
                </div>
                <div class="section">
                    <h2>Authentication Status</h2>
                    <div id="auth-status"></div>
                </div>
                <div class="section">
                    <h2>API Connection</h2>
                    <div id="api-status"></div>
                </div>
                <div class="section">
                    <h2>LocalStorage Data</h2>
                    <div id="storage-status"></div>
                </div>
            </div>
        </div>

        <!-- Authentication Tab -->
        <div id="auth-tab" class="tab-content">
            <div class="section">
                <h2>Quick Authentication Actions</h2>
                <button class="success" onclick="setTestApiKey()">Set Test API Key</button>
                <button class="danger" onclick="clearAllAuth()">Clear All Auth</button>
                <button onclick="testEmergencyLogin()">Test Emergency Login</button>
                <button onclick="copyAuthDebugData()">Copy Auth Debug Data</button>
                
                <div style="margin-top: 20px;">
                    <h3>Manual Login</h3>
                    <input type="text" id="login-email" placeholder="Email" value="admin@jaydenmetz.com">
                    <input type="password" id="login-password" placeholder="Password" value="AdminPassword123">
                    <button onclick="performLogin()">Login</button>
                </div>
                
                <div id="auth-response" class="response-viewer" style="display: none;"></div>
            </div>
        </div>

        <!-- API Testing Tab -->
        <div id="api-tab" class="tab-content">
            <div class="section">
                <h2>API Endpoint Tester</h2>
                <select id="api-method">
                    <option value="GET">GET</option>
                    <option value="POST">POST</option>
                    <option value="PUT">PUT</option>
                    <option value="DELETE">DELETE</option>
                </select>
                <input type="text" id="api-endpoint" placeholder="Endpoint (e.g., /escrows)" value="/escrows">
                <textarea id="api-body" placeholder="Request body (JSON)" style="width: 100%; height: 100px; background: #1e1e1e; border: 1px solid #3e3e42; color: #d4d4d4; border-radius: 4px; padding: 8px; margin-bottom: 10px; font-family: 'Courier New', monospace;"></textarea>
                <button onclick="testApiCall()">Send Request</button>
                <button onclick="testEscrowDetail()">Test Escrow Detail</button>
                <button onclick="testAllEndpoints()">Test All Endpoints</button>
                
                <div id="api-response" class="response-viewer" style="display: none;"></div>
            </div>
        </div>

        <!-- Logs Tab -->
        <div id="logs-tab" class="tab-content">
            <div class="section">
                <h2>Console Output</h2>
                <button onclick="clearLogs()">Clear Logs</button>
                <button onclick="copyLogs()">Copy Logs</button>
                <div id="console-logs" class="log-container"></div>
            </div>
        </div>

        <!-- Debug Data Tab -->
        <div id="data-tab" class="tab-content">
            <div class="section">
                <h2>Full Debug Context</h2>
                <button onclick="generateFullDebugReport()">Generate Debug Report</button>
                <button onclick="copyDebugReport()">Copy Debug Report</button>
                <pre id="debug-report"></pre>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://api.jaydenmetz.com/v1';
        const TEST_API_KEY = 'test_api_key_3f8a2b1c9d5e7f0a4b6c8d2e4f6a8b0c1d3e5f7a9b1c3d5e7f9a0b2c4d6e8f0a';
        let logs = [];

        // Override console methods to capture logs
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        console.log = function(...args) {
            addLog('info', args.join(' '));
            originalLog.apply(console, args);
        };

        console.error = function(...args) {
            addLog('error', args.join(' '));
            originalError.apply(console, args);
        };

        console.warn = function(...args) {
            addLog('warn', args.join(' '));
            originalWarn.apply(console, args);
        };

        function addLog(type, message) {
            logs.push({ type, message, timestamp: new Date().toISOString() });
            updateLogsDisplay();
        }

        function updateLogsDisplay() {
            const container = document.getElementById('console-logs');
            if (container) {
                container.innerHTML = logs.slice(-50).reverse().map(log => 
                    `<div class="log-entry ${log.type}">
                        <span style="color: #808080;">[${new Date(log.timestamp).toLocaleTimeString()}]</span>
                        ${escapeHtml(log.message)}
                    </div>`
                ).join('');
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        function updateStatus() {
            // Environment Status
            const envHtml = `
                <div class="status-item">
                    <span class="status-label">Current URL:</span>
                    <span class="status-value">${window.location.href}</span>
                </div>
                <div class="status-item">
                    <span class="status-label">API Base URL:</span>
                    <span class="status-value">${API_BASE_URL}</span>
                </div>
                <div class="status-item">
                    <span class="status-label">User Agent:</span>
                    <span class="status-value">${navigator.userAgent.substring(0, 50)}...</span>
                </div>
            `;
            document.getElementById('environment-status').innerHTML = envHtml;

            // Auth Status
            const hasToken = !!localStorage.getItem('crm_auth_token');
            const hasApiKey = !!localStorage.getItem('test_api_key');
            const authHtml = `
                <div class="status-item">
                    <span class="status-label">JWT Token:</span>
                    <span class="status-value ${hasToken ? 'success' : 'error'}">${hasToken ? 'Present' : 'Missing'}</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Test API Key:</span>
                    <span class="status-value ${hasApiKey ? 'success' : 'error'}">${hasApiKey ? 'Present' : 'Missing'}</span>
                </div>
                <div class="status-item">
                    <span class="status-label">User Data:</span>
                    <span class="status-value">${localStorage.getItem('user') ? 'Present' : 'Missing'}</span>
                </div>
            `;
            document.getElementById('auth-status').innerHTML = authHtml;

            // Storage Status
            const storageKeys = Object.keys(localStorage);
            const storageHtml = storageKeys.map(key => `
                <div class="status-item">
                    <span class="status-label">${key}:</span>
                    <span class="status-value">${localStorage.getItem(key).substring(0, 30)}...</span>
                </div>
            `).join('');
            document.getElementById('storage-status').innerHTML = storageHtml || '<div>No data in localStorage</div>';
        }

        async function testApiConnection() {
            try {
                const response = await fetch(`${API_BASE_URL}/health`);
                const data = await response.json();
                
                const statusHtml = `
                    <div class="status-item">
                        <span class="status-label">Health Check:</span>
                        <span class="status-value ${data.success ? 'success' : 'error'}">${data.success ? 'OK' : 'Failed'}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Database:</span>
                        <span class="status-value ${data.data?.database?.connected ? 'success' : 'error'}">
                            ${data.data?.database?.connected ? 'Connected' : 'Disconnected'}
                        </span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Environment:</span>
                        <span class="status-value">${data.data?.environment || 'Unknown'}</span>
                    </div>
                `;
                document.getElementById('api-status').innerHTML = statusHtml;
            } catch (error) {
                document.getElementById('api-status').innerHTML = `
                    <div class="status-item">
                        <span class="status-label">Connection:</span>
                        <span class="status-value error">Failed - ${error.message}</span>
                    </div>
                `;
            }
        }

        function setTestApiKey() {
            localStorage.setItem('test_api_key', TEST_API_KEY);
            addLog('success', 'Test API key has been set');
            updateStatus();
        }

        function clearAllAuth() {
            localStorage.removeItem('crm_auth_token');
            localStorage.removeItem('authToken');
            localStorage.removeItem('token');
            localStorage.removeItem('test_api_key');
            localStorage.removeItem('user');
            addLog('info', 'All authentication data cleared');
            updateStatus();
        }

        async function testEmergencyLogin() {
            try {
                const response = await fetch(`${API_BASE_URL}/auth/emergency-login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'admin@jaydenmetz.com',
                        password: 'AdminPassword123'
                    })
                });
                
                const data = await response.json();
                document.getElementById('auth-response').style.display = 'block';
                document.getElementById('auth-response').innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                
                if (data.success && data.data.token) {
                    localStorage.setItem('crm_auth_token', data.data.token);
                    if (data.data.user) {
                        localStorage.setItem('user', JSON.stringify(data.data.user));
                    }
                    addLog('success', 'Emergency login successful - token saved');
                    updateStatus();
                } else {
                    addLog('error', 'Emergency login failed');
                }
            } catch (error) {
                addLog('error', `Emergency login error: ${error.message}`);
                document.getElementById('auth-response').style.display = 'block';
                document.getElementById('auth-response').innerHTML = `<pre style="color: #f48771;">Error: ${error.message}</pre>`;
            }
        }

        async function performLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                document.getElementById('auth-response').style.display = 'block';
                document.getElementById('auth-response').innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                
                if (data.success && data.data.token) {
                    localStorage.setItem('crm_auth_token', data.data.token);
                    if (data.data.user) {
                        localStorage.setItem('user', JSON.stringify(data.data.user));
                    }
                    addLog('success', 'Login successful - token saved');
                    updateStatus();
                } else {
                    addLog('error', `Login failed: ${data.error?.message || 'Unknown error'}`);
                }
            } catch (error) {
                addLog('error', `Login error: ${error.message}`);
                document.getElementById('auth-response').style.display = 'block';
                document.getElementById('auth-response').innerHTML = `<pre style="color: #f48771;">Error: ${error.message}</pre>`;
            }
        }

        async function testApiCall() {
            const method = document.getElementById('api-method').value;
            const endpoint = document.getElementById('api-endpoint').value;
            const body = document.getElementById('api-body').value;
            
            const headers = { 'Content-Type': 'application/json' };
            
            // Add authentication
            const apiKey = localStorage.getItem('test_api_key');
            const token = localStorage.getItem('crm_auth_token');
            
            if (apiKey) {
                headers['X-API-Key'] = apiKey;
            } else if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            
            const options = { method, headers };
            if (method !== 'GET' && body) {
                try {
                    options.body = body;
                } catch (e) {
                    addLog('error', 'Invalid JSON in request body');
                    return;
                }
            }
            
            try {
                const url = endpoint.startsWith('http') ? endpoint : `${API_BASE_URL}${endpoint}`;
                addLog('info', `${method} ${url}`);
                
                const response = await fetch(url, options);
                const data = await response.json();
                
                document.getElementById('api-response').style.display = 'block';
                document.getElementById('api-response').innerHTML = `
                    <div>Status: ${response.status} ${response.statusText}</div>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
                
                addLog(response.ok ? 'success' : 'error', `Response: ${response.status}`);
            } catch (error) {
                addLog('error', `API call error: ${error.message}`);
                document.getElementById('api-response').style.display = 'block';
                document.getElementById('api-response').innerHTML = `<pre style="color: #f48771;">Error: ${error.message}</pre>`;
            }
        }

        async function testEscrowDetail() {
            const testId = '572e8a77-5556-4c9e-b551-47ed0913beb9';
            document.getElementById('api-endpoint').value = `/escrows/${testId}`;
            document.getElementById('api-method').value = 'GET';
            await testApiCall();
        }

        async function testAllEndpoints() {
            const endpoints = [
                { method: 'GET', path: '/health' },
                { method: 'GET', path: '/escrows' },
                { method: 'GET', path: '/escrows/572e8a77-5556-4c9e-b551-47ed0913beb9' },
                { method: 'GET', path: '/listings' },
                { method: 'GET', path: '/clients' },
                { method: 'GET', path: '/appointments' },
                { method: 'GET', path: '/leads' }
            ];
            
            for (const endpoint of endpoints) {
                document.getElementById('api-method').value = endpoint.method;
                document.getElementById('api-endpoint').value = endpoint.path;
                await testApiCall();
                await new Promise(resolve => setTimeout(resolve, 500));
            }
        }

        function generateFullDebugReport() {
            const report = {
                timestamp: new Date().toISOString(),
                environment: {
                    url: window.location.href,
                    apiBaseUrl: API_BASE_URL,
                    userAgent: navigator.userAgent
                },
                authentication: {
                    hasJWTToken: !!localStorage.getItem('crm_auth_token'),
                    hasAPIKey: !!localStorage.getItem('test_api_key'),
                    tokenLocations: {
                        crm_auth_token: !!localStorage.getItem('crm_auth_token'),
                        authToken: !!localStorage.getItem('authToken'),
                        token: !!localStorage.getItem('token'),
                        test_api_key: !!localStorage.getItem('test_api_key')
                    },
                    user: JSON.parse(localStorage.getItem('user') || '{}')
                },
                localStorage: Object.fromEntries(
                    Object.keys(localStorage).map(key => [key, localStorage.getItem(key)])
                ),
                consoleLogs: logs.slice(-100)
            };
            
            document.getElementById('debug-report').textContent = JSON.stringify(report, null, 2);
            addLog('info', 'Debug report generated');
        }

        function copyDebugReport() {
            const report = document.getElementById('debug-report').textContent;
            navigator.clipboard.writeText(report).then(() => {
                addLog('success', 'Debug report copied to clipboard');
            });
        }

        function copyAuthDebugData() {
            const data = {
                timestamp: new Date().toISOString(),
                tokens: {
                    jwt: localStorage.getItem('crm_auth_token'),
                    apiKey: localStorage.getItem('test_api_key')
                },
                user: JSON.parse(localStorage.getItem('user') || '{}')
            };
            navigator.clipboard.writeText(JSON.stringify(data, null, 2)).then(() => {
                addLog('success', 'Auth debug data copied to clipboard');
            });
        }

        function copyLogs() {
            const logText = logs.map(log => 
                `[${new Date(log.timestamp).toLocaleTimeString()}] ${log.type.toUpperCase()}: ${log.message}`
            ).join('\n');
            navigator.clipboard.writeText(logText).then(() => {
                addLog('success', 'Logs copied to clipboard');
            });
        }

        function clearLogs() {
            logs = [];
            updateLogsDisplay();
            addLog('info', 'Logs cleared');
        }

        // Initialize on load
        window.onload = function() {
            updateStatus();
            testApiConnection();
            addLog('info', 'Debug console initialized');
        };

        // Auto-refresh status
        setInterval(() => {
            updateStatus();
        }, 5000);
    </script>
</body>
</html>